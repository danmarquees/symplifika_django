<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Integra√ß√£o Backend - Symplifika</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background: #f8fafc;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            background: white;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .test-section h3 {
            margin-top: 0;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
        }

        .field-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .contenteditable {
            border: 2px solid #e5e7eb;
            padding: 12px;
            border-radius: 6px;
            min-height: 80px;
            background: white;
        }

        .contenteditable:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        button:hover {
            background: #3730a3;
        }

        button.secondary {
            background: #6b7280;
        }

        button.secondary:hover {
            background: #4b5563;
        }

        button.danger {
            background: #ef4444;
        }

        button.danger:hover {
            background: #dc2626;
        }

        .info-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            padding: 12px;
            margin: 15px 0;
            font-size: 14px;
            color: #1e40af;
        }

        .debug-output {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            white-space: pre-wrap;
        }

        .shortcut-list {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .shortcut-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shortcut-trigger {
            font-weight: 600;
            color: #4f46e5;
            font-size: 12px;
            background: #eff6ff;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stat-card {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4f46e5;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Teste Integra√ß√£o Backend - Symplifika</h1>
        <p>Teste completo da integra√ß√£o do Quick Access Icon com o backend</p>
        <div id="connection-status" class="status-indicator status-warning">
            ‚è≥ Verificando conex√£o...
        </div>
    </div>

    <div class="test-section">
        <h3>üìä Status da Conex√£o</h3>
        <div class="controls">
            <button onclick="checkConnection()">Verificar Conex√£o</button>
            <button onclick="forceSync()" class="secondary">Sincronizar Atalhos</button>
            <button onclick="clearStorage()" class="danger">Limpar Storage</button>
        </div>

        <div id="backend-info" class="info-box" style="display: none;">
            <strong>Informa√ß√µes do Backend:</strong>
            <div id="backend-details"></div>
        </div>

        <div class="stats-grid" id="stats-container" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="total-shortcuts">0</div>
                <div class="stat-label">Total Atalhos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="active-shortcuts">0</div>
                <div class="stat-label">Atalhos Ativos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="last-sync">Nunca</div>
                <div class="stat-label">√öltima Sincroniza√ß√£o</div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>üìù Campos de Teste - Quick Access</h3>
        <div class="info-box">
            <strong>Instru√ß√µes:</strong> Passe o mouse sobre os campos abaixo para testar o Quick Access Icon.
            Os √≠cones devem aparecer no canto direito de cada campo e mostrar seus atalhos reais do backend.
        </div>

        <div class="field-row">
            <input type="text" placeholder="Campo de texto - Email" id="email-field">
            <input type="text" placeholder="Campo de texto - Nome" id="name-field">
        </div>

        <div class="field-row">
            <input type="email" placeholder="endere√ßo@email.com" id="email-input">
            <input type="tel" placeholder="+55 (11) 99999-9999" id="phone-input">
        </div>

        <textarea placeholder="√Årea de texto para conte√∫dos longos, templates, etc." id="content-textarea"></textarea>

        <div class="contenteditable" contenteditable="true" data-placeholder="Div edit√°vel - digite aqui..." id="editable-div">
            Div edit√°vel - clique para editar
        </div>
    </div>

    <div class="test-section">
        <h3>‚ö° Seus Atalhos Ativos</h3>
        <div class="controls">
            <button onclick="loadShortcuts()">Carregar Atalhos</button>
            <button onclick="loadMostUsed()" class="secondary">Mais Usados</button>
        </div>

        <div id="shortcuts-container" class="shortcut-list">
            <div style="text-align: center; padding: 20px; color: #6b7280;">
                Clique em "Carregar Atalhos" para ver seus atalhos
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>üß™ Testes Manuais</h3>
        <div class="controls">
            <button onclick="testShortcutExpansion()">Testar Expans√£o</button>
            <button onclick="testAuthentication()">Testar Autentica√ß√£o</button>
            <button onclick="simulateQuickAccess()">Simular Quick Access</button>
        </div>

        <div class="info-box">
            <strong>Teste Expans√£o:</strong> Testa se um atalho espec√≠fico pode ser expandido<br>
            <strong>Teste Autentica√ß√£o:</strong> Verifica se o usu√°rio est√° autenticado<br>
            <strong>Simular Quick Access:</strong> For√ßa a exibi√ß√£o do tooltip de atalhos
        </div>
    </div>

    <div class="test-section">
        <h3>üìã Debug Output</h3>
        <div class="controls">
            <button onclick="clearDebug()">Limpar Debug</button>
            <button onclick="exportLogs()">Exportar Logs</button>
        </div>
        <div id="debug-output" class="debug-output">
            Aguardando opera√ß√µes...
        </div>
    </div>

    <script>
        let debugOutput = document.getElementById('debug-output');
        let shortcuts = [];

        // Interceptar logs para debug
        const originalLog = console.log;
        const originalError = console.error;

        function addToDebug(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef4444' :
                         type === 'warn' ? '#f59e0b' : '#10b981';

            debugOutput.innerHTML += `<span style="color: ${color};">[${timestamp}] ${message}</span>\n`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToDebug(args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToDebug(args.join(' '), 'error');
        };

        // Fun√ß√µes de teste
        async function checkConnection() {
            addToDebug('üîç Verificando conex√£o com backend...');

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'init'
                });

                if (response && response.success) {
                    document.getElementById('connection-status').className = 'status-indicator status-success';
                    document.getElementById('connection-status').innerHTML = '‚úÖ Conectado';

                    document.getElementById('backend-info').style.display = 'block';
                    document.getElementById('backend-details').innerHTML = `
                        Autenticado: ${response.authenticated ? 'Sim' : 'N√£o'}<br>
                        Atalhos: ${response.shortcuts || 0}<br>
                        √öltima Sync: ${response.lastSync || 'Nunca'}
                    `;

                    document.getElementById('stats-container').style.display = 'grid';
                    document.getElementById('total-shortcuts').textContent = response.shortcuts || 0;
                    document.getElementById('last-sync').textContent = response.lastSync ?
                        new Date(response.lastSync).toLocaleString() : 'Nunca';

                    addToDebug('‚úÖ Conex√£o estabelecida com sucesso');
                } else {
                    throw new Error('Resposta inv√°lida do backend');
                }
            } catch (error) {
                document.getElementById('connection-status').className = 'status-indicator status-error';
                document.getElementById('connection-status').innerHTML = '‚ùå Erro na conex√£o';
                addToDebug(`‚ùå Erro na conex√£o: ${error.message}`, 'error');
            }
        }

        async function forceSync() {
            addToDebug('üîÑ For√ßando sincroniza√ß√£o...');

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'syncShortcuts'
                });

                if (response && response.success) {
                    addToDebug(`‚úÖ Sincroniza√ß√£o conclu√≠da: ${response.shortcuts} atalhos`);
                    document.getElementById('total-shortcuts').textContent = response.shortcuts;
                    document.getElementById('last-sync').textContent =
                        new Date(response.lastSync).toLocaleString();
                } else {
                    addToDebug('‚ùå Falha na sincroniza√ß√£o', 'error');
                }
            } catch (error) {
                addToDebug(`‚ùå Erro na sincroniza√ß√£o: ${error.message}`, 'error');
            }
        }

        async function loadShortcuts() {
            addToDebug('üìö Carregando todos os atalhos...');

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'getShortcuts'
                });

                if (response && response.shortcuts) {
                    shortcuts = response.shortcuts;
                    displayShortcuts(shortcuts);
                    addToDebug(`‚úÖ ${shortcuts.length} atalhos carregados`);
                } else {
                    addToDebug('‚ùå Nenhum atalho encontrado', 'warn');
                }
            } catch (error) {
                addToDebug(`‚ùå Erro ao carregar atalhos: ${error.message}`, 'error');
            }
        }

        async function loadMostUsed() {
            addToDebug('‚≠ê Carregando atalhos mais usados...');

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'getMostUsed'
                });

                if (response && response.shortcuts) {
                    displayShortcuts(response.shortcuts, 'Mais Usados');
                    addToDebug(`‚úÖ ${response.shortcuts.length} atalhos mais usados carregados`);
                } else {
                    addToDebug('‚ùå Nenhum atalho mais usado encontrado', 'warn');
                }
            } catch (error) {
                addToDebug(`‚ùå Erro ao carregar mais usados: ${error.message}`, 'error');
            }
        }

        function displayShortcuts(shortcutList, title = 'Atalhos') {
            const container = document.getElementById('shortcuts-container');

            if (!shortcutList || shortcutList.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6b7280;">
                        Nenhum atalho encontrado
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 10px; color: #374151;">
                    ${title} (${shortcutList.length})
                </div>
            `;

            shortcutList.forEach(shortcut => {
                const item = document.createElement('div');
                item.className = 'shortcut-item';
                item.innerHTML = `
                    <div>
                        <span class="shortcut-trigger">${shortcut.trigger || '#' + shortcut.id}</span>
                        <span style="margin-left: 8px; font-weight: 500;">${shortcut.title}</span>
                        ${shortcut.category ? `<small style="color: #6b7280; margin-left: 8px;">[${shortcut.category.name}]</small>` : ''}
                    </div>
                    <button onclick="testShortcut(${shortcut.id})" style="font-size: 12px; padding: 4px 8px;">Testar</button>
                `;
                container.appendChild(item);
            });
        }

        async function testShortcut(shortcutId) {
            addToDebug(`üß™ Testando expans√£o do atalho ID: ${shortcutId}`);

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'useShortcut',
                    shortcutId: shortcutId,
                    variables: {}
                });

                if (response && response.content) {
                    addToDebug(`‚úÖ Atalho expandido: "${response.content.substring(0, 50)}..."`);

                    // Inserir no primeiro campo de texto
                    const field = document.getElementById('email-field');
                    field.value = response.content;
                    field.focus();
                } else {
                    addToDebug('‚ùå Falha na expans√£o do atalho', 'error');
                }
            } catch (error) {
                addToDebug(`‚ùå Erro ao testar atalho: ${error.message}`, 'error');
            }
        }

        async function testAuthentication() {
            addToDebug('üîê Testando autentica√ß√£o...');

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'init'
                });

                if (response && response.authenticated) {
                    addToDebug('‚úÖ Usu√°rio autenticado com sucesso');
                } else {
                    addToDebug('‚ùå Usu√°rio n√£o autenticado', 'warn');
                }
            } catch (error) {
                addToDebug(`‚ùå Erro na verifica√ß√£o de autentica√ß√£o: ${error.message}`, 'error');
            }
        }

        function simulateQuickAccess() {
            addToDebug('‚ö° Simulando Quick Access...');

            // Tentar acessar a inst√¢ncia do QuickAccessIcon
            if (window.symphilikaContentScript && window.symphilikaContentScript.quickAccessIcon) {
                const field = document.getElementById('email-field');
                const icon = window.symphilikaContentScript.quickAccessIcon.activeIcons.get(field);

                if (icon) {
                    window.symphilikaContentScript.quickAccessIcon.showTooltip(field, icon);
                    addToDebug('‚úÖ Tooltip for√ßado a aparecer');
                } else {
                    addToDebug('‚ùå √çcone n√£o encontrado para o campo', 'warn');
                }
            } else {
                addToDebug('‚ùå QuickAccessIcon n√£o dispon√≠vel', 'error');
            }
        }

        function clearStorage() {
            addToDebug('üóëÔ∏è Limpando storage local...');
            chrome.storage.local.clear(() => {
                addToDebug('‚úÖ Storage limpo com sucesso');
                document.getElementById('connection-status').className = 'status-indicator status-warning';
                document.getElementById('connection-status').innerHTML = '‚è≥ Verificando conex√£o...';
            });
        }

        function clearDebug() {
            debugOutput.innerHTML = 'Debug limpo...\n';
        }

        function exportLogs() {
            const logs = debugOutput.textContent;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `symplifika-debug-${new Date().toISOString()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            addToDebug('üìÑ Logs exportados com sucesso');
        }

        // Monitorar hovers para debug
        document.querySelectorAll('input, textarea, [contenteditable="true"]').forEach(field => {
            field.addEventListener('mouseenter', () => {
                addToDebug(`üëÜ Mouse over campo: ${field.tagName} (${field.type || 'contenteditable'})`);

                setTimeout(() => {
                    const icons = document.querySelectorAll('.symplifika-icon');
                    addToDebug(`üîç √çcones encontrados ap√≥s hover: ${icons.length}`);
                }, 200);
            });
        });

        // Verifica√ß√£o inicial
        setTimeout(checkConnection, 1000);

        addToDebug('üöÄ P√°gina de teste carregada - pronta para testes!');
    </script>
</body>
</html>
