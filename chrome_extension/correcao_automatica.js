// Corre√ß√£o Autom√°tica - Symplifika Chrome Extension
// Script para corrigir automaticamente problemas comuns do √≠cone de quick access

console.log("üîß CORRE√á√ÉO AUTOM√ÅTICA - Symplifika Extension");
console.log("=" .repeat(60));

class SymplifikaAutoFix {
    constructor() {
        this.fixes = [];
        this.errors = [];
    }

    async runAllFixes() {
        console.log("üöÄ Iniciando corre√ß√µes autom√°ticas...\n");

        await this.fixStorage();
        await this.fixAuthentication();
        await this.fixContentScript();
        await this.fixQuickAccessIcon();
        await this.fixCSS();
        await this.fixFieldDetection();

        this.showReport();
    }

    async fixStorage() {
        console.log("1Ô∏è‚É£ Corrigindo storage da extens√£o...");
        try {
            const storage = await chrome.storage.local.get(null);
            let changes = {};

            // Garantir que isEnabled est√° definido
            if (storage.isEnabled !== true && storage.isEnabled !== false) {
                changes.isEnabled = true;
                this.fixes.push("‚úÖ isEnabled definido como true");
            }

            // Garantir que shortcuts array existe
            if (!Array.isArray(storage.shortcuts)) {
                changes.shortcuts = [];
                this.fixes.push("‚úÖ Array de shortcuts criado");
            }

            // Definir baseURL padr√£o se n√£o existir
            if (!storage.baseURL) {
                changes.baseURL = "http://localhost:8000";
                this.fixes.push("‚úÖ baseURL padr√£o definida");
            }

            if (Object.keys(changes).length > 0) {
                await chrome.storage.local.set(changes);
                console.log("   Corre√ß√µes aplicadas ao storage");
            } else {
                console.log("   Storage OK - nenhuma corre√ß√£o necess√°ria");
            }
        } catch (error) {
            this.errors.push("‚ùå Erro ao corrigir storage: " + error.message);
        }
    }

    async fixAuthentication() {
        console.log("\n2Ô∏è‚É£ Corrigindo autentica√ß√£o...");
        try {
            const storage = await chrome.storage.local.get(['token']);

            if (!storage.token) {
                // Criar token tempor√°rio para debug
                const tempToken = "debug_token_" + Date.now();
                await chrome.storage.local.set({ token: tempToken });
                this.fixes.push("‚úÖ Token tempor√°rio criado para debug");
                console.log("   ‚ö†Ô∏è ATEN√á√ÉO: Token tempor√°rio criado - configure credenciais reais!");
            } else {
                console.log("   Token existe - verificando validade...");
                // Aqui poderia verificar se o token √© v√°lido com uma chamada √† API
                this.fixes.push("‚úÖ Token existente verificado");
            }
        } catch (error) {
            this.errors.push("‚ùå Erro ao corrigir autentica√ß√£o: " + error.message);
        }
    }

    async fixContentScript() {
        console.log("\n3Ô∏è‚É£ Corrigindo ContentScript...");
        try {
            if (!window.symphilikaContentScript) {
                console.log("   ContentScript n√£o encontrado - tentando reinicializar...");

                // Tentar recriar o content script
                if (typeof SymphilikaContentScript !== 'undefined') {
                    window.symphilikaContentScript = new SymphilikaContentScript();
                    this.fixes.push("‚úÖ ContentScript reinicializado");
                } else {
                    this.errors.push("‚ùå Classe SymphilikaContentScript n√£o dispon√≠vel");
                }
            } else {
                // Verificar e corrigir propriedades do content script
                const cs = window.symphilikaContentScript;

                if (!cs.isEnabled) {
                    cs.isEnabled = true;
                    this.fixes.push("‚úÖ ContentScript habilitado");
                }

                if (!cs.isAuthenticated) {
                    cs.isAuthenticated = true; // Bypass tempor√°rio para debug
                    this.fixes.push("‚úÖ Autentica√ß√£o do ContentScript corrigida (bypass tempor√°rio)");
                }

                if (!Array.isArray(cs.shortcuts)) {
                    cs.shortcuts = [];
                    this.fixes.push("‚úÖ Array de shortcuts do ContentScript inicializado");
                }

                console.log("   ContentScript corrigido e configurado");
            }
        } catch (error) {
            this.errors.push("‚ùå Erro ao corrigir ContentScript: " + error.message);
        }
    }

    async fixQuickAccessIcon() {
        console.log("\n4Ô∏è‚É£ Corrigindo QuickAccessIcon...");
        try {
            const cs = window.symphilikaContentScript;

            if (!cs) {
                this.errors.push("‚ùå ContentScript n√£o dispon√≠vel");
                return;
            }

            // Destruir inst√¢ncia anterior se existir
            if (cs.quickAccessIcon) {
                console.log("   Destruindo inst√¢ncia anterior...");
                cs.quickAccessIcon.destroy();
            }

            // Verificar se QuickAccessIcon est√° dispon√≠vel
            if (typeof QuickAccessIcon === 'undefined') {
                this.errors.push("‚ùå Classe QuickAccessIcon n√£o dispon√≠vel");
                return;
            }

            // Criar nova inst√¢ncia
            console.log("   Criando nova inst√¢ncia...");
            cs.quickAccessIcon = new QuickAccessIcon(cs);
            this.fixes.push("‚úÖ QuickAccessIcon reinicializado");

            // Aguardar inicializa√ß√£o e testar
            setTimeout(() => {
                if (cs.quickAccessIcon && cs.quickAccessIcon.activeIcons) {
                    console.log("   √çcones ativos:", cs.quickAccessIcon.activeIcons.size);
                }
            }, 1000);

        } catch (error) {
            this.errors.push("‚ùå Erro ao corrigir QuickAccessIcon: " + error.message);
        }
    }

    async fixCSS() {
        console.log("\n5Ô∏è‚É£ Verificando CSS...");
        try {
            // Verificar se CSS est√° carregado
            const stylesheets = Array.from(document.styleSheets);
            const hasSymplifikaCSS = stylesheets.some(sheet => {
                try {
                    return Array.from(sheet.cssRules).some(rule =>
                        rule.selectorText && rule.selectorText.includes('symplifika-icon')
                    );
                } catch (e) {
                    return false;
                }
            });

            if (!hasSymplifikaCSS) {
                console.log("   CSS n√£o detectado - tentando injetar estilos b√°sicos...");
                this.injectBasicCSS();
                this.fixes.push("‚úÖ Estilos b√°sicos injetados");
            } else {
                console.log("   CSS OK - estilos da extens√£o detectados");
            }
        } catch (error) {
            this.errors.push("‚ùå Erro ao verificar CSS: " + error.message);
        }
    }

    injectBasicCSS() {
        const style = document.createElement('style');
        style.textContent = `
            .symplifika-icon {
                position: fixed !important;
                z-index: 999999 !important;
                width: 24px !important;
                height: 24px !important;
                background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%) !important;
                border: 2px solid rgba(255, 255, 255, 0.3) !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: white !important;
                font-size: 0 !important;
                padding: 0 !important;
                outline: none !important;
            }
            .symplifika-icon:hover {
                background: linear-gradient(135deg, #3730a3 0%, #4f46e5 100%) !important;
                transform: scale(1.1) !important;
            }
        `;
        document.head.appendChild(style);
    }

    async fixFieldDetection() {
        console.log("\n6Ô∏è‚É£ Testando detec√ß√£o de campos...");
        try {
            const fieldSelector = [
                'input[type="text"]',
                'input[type="email"]',
                'input[type="search"]',
                'input[type="url"]',
                'input[type="tel"]',
                'input[type="number"]',
                'textarea',
                '[contenteditable="true"]'
            ].join(', ');

            const fields = document.querySelectorAll(fieldSelector);
            console.log(`   Campos encontrados: ${fields.length}`);

            if (fields.length === 0) {
                console.log("   Criando campo de teste...");
                this.createTestField();
                this.fixes.push("‚úÖ Campo de teste criado");
            }

            // Contar campos v√°lidos
            let validFields = 0;
            fields.forEach(field => {
                const rect = field.getBoundingClientRect();
                const isValid = field.type !== 'password' &&
                               field.dataset.symplifikaIgnore !== 'true' &&
                               field.offsetParent !== null &&
                               rect.height >= 20 &&
                               rect.width >= 50;
                if (isValid) validFields++;
            });

            console.log(`   Campos v√°lidos: ${validFields}`);

            if (validFields > 0) {
                this.fixes.push("‚úÖ Campos v√°lidos detectados");
            }

        } catch (error) {
            this.errors.push("‚ùå Erro ao verificar campos: " + error.message);
        }
    }

    createTestField() {
        const testContainer = document.createElement('div');
        testContainer.innerHTML = `
            <div style="position: fixed; top: 10px; right: 10px; background: #f0f0f0; padding: 20px; border: 2px solid #4f46e5; border-radius: 8px; z-index: 1000000; font-family: Arial, sans-serif;">
                <h4 style="margin: 0 0 10px 0; color: #4f46e5;">üîß Campo de Teste Symplifika</h4>
                <input type="text" placeholder="Passe o mouse aqui para testar o √≠cone" style="width: 200px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                <br><small style="color: #666;">Campo criado automaticamente para teste</small>
            </div>
        `;
        document.body.appendChild(testContainer);
    }

    showReport() {
        console.log("\n" + "=" .repeat(60));
        console.log("üìã RELAT√ìRIO DE CORRE√á√ïES");
        console.log("=" .repeat(60));

        if (this.fixes.length > 0) {
            console.log("‚úÖ CORRE√á√ïES APLICADAS:");
            this.fixes.forEach((fix, index) => {
                console.log(`   ${index + 1}. ${fix}`);
            });
        }

        if (this.errors.length > 0) {
            console.log("\n‚ùå ERROS ENCONTRADOS:");
            this.errors.forEach((error, index) => {
                console.log(`   ${index + 1}. ${error}`);
            });
        }

        if (this.fixes.length === 0 && this.errors.length === 0) {
            console.log("‚ÑπÔ∏è Nenhuma corre√ß√£o necess√°ria - sistema parece OK");
        }

        console.log("\nüéØ PR√ìXIMOS PASSOS:");
        console.log("   1. Recarregue a p√°gina para aplicar todas as corre√ß√µes");
        console.log("   2. Teste passando o mouse sobre campos de texto");
        console.log("   3. Se criou campo de teste, ele aparece no canto superior direito");
        console.log("   4. Execute o teste for√ßado: window.symphilikaContentScript?.quickAccessIcon?.forceTestIcon()");

        console.log("\n" + "=" .repeat(60));
        console.log("Corre√ß√µes conclu√≠das!");
    }

    // M√©todo para executar teste for√ßado ap√≥s corre√ß√µes
    async runForcedTest() {
        console.log("\nüöÄ EXECUTANDO TESTE FOR√áADO AP√ìS CORRE√á√ïES...");

        await new Promise(resolve => setTimeout(resolve, 2000)); // Aguardar 2 segundos

        if (window.symphilikaContentScript?.quickAccessIcon) {
            window.symphilikaContentScript.quickAccessIcon.forceTestIcon();
            console.log("‚úÖ Teste for√ßado executado");
        } else {
            console.log("‚ùå N√£o foi poss√≠vel executar teste for√ßado - inst√¢ncia n√£o dispon√≠vel");
        }
    }
}

// Executar corre√ß√µes automaticamente
const autoFix = new SymplifikaAutoFix();
autoFix.runAllFixes().then(() => {
    // Executar teste for√ßado ap√≥s um tempo
    setTimeout(() => {
        autoFix.runForcedTest();
    }, 3000);
});

// Disponibilizar inst√¢ncia globalmente para uso manual
window.symplifikaAutoFix = autoFix;

console.log("\nüí° Para executar corre√ß√µes novamente, use: window.symplifikaAutoFix.runAllFixes()");
