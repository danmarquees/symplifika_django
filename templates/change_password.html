{% extends 'base.html' %}
{% load static %}

{% block title %}Alterar Senha | Symplifika{% endblock %}

{% block meta_description %}Altere sua senha de acesso no Symplifika{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="max-w-md mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center space-x-4 mb-4">
                <a href="{% url 'core:profile' %}"
                   class="text-symplifika-primary hover:text-symplifika-accent transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <div></div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Alterar Senha</h1>
                </div>
            </div>
            <p class="text-gray-600 dark:text-gray-400">
                Mantenha sua conta segura com uma senha forte
            </p>
        </div>

        <!-- Change Password Form -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <form method="post" id="passwordForm" class="space-y-6">
                {% csrf_token %}

                <!-- Current Password -->
                <div>
                    <label for="current_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Senha Atual *
                    </label>
                    <div class="relative">
                        <input type="password"
                               id="current_password"
                               name="current_password"
                               required
                               class="w-full px-3 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-symplifika-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <button type="button"
                                onclick="togglePassword('current_password')"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <svg class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- New Password -->
                <div>
                    <label for="new_password1" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Nova Senha *
                    </label>
                    <div class="relative">
                        <input type="password"
                               id="new_password1"
                               name="new_password1"
                               required
                               class="w-full px-3 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-symplifika-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <button type="button"
                                onclick="togglePassword('new_password1')"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <svg class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Confirm New Password -->
                <div>
                    <label for="new_password2" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Confirmar Nova Senha *
                    </label>
                    <div class="relative">
                        <input type="password"
                               id="new_password2"
                               name="new_password2"
                               required
                               class="w-full px-3 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-symplifika-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <button type="button"
                                onclick="togglePassword('new_password2')"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <svg class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="password-match-message" class="mt-1 text-sm hidden"></div>
                </div>

                <!-- Password Strength Indicator -->
                <div class="mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Força da senha:</span>
                        <span id="strength-text" class="text-sm"></span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="strength-bar" class="h-2 rounded-full transition-all duration-300"></div>
                    </div>
                </div>

                <!-- Password Requirements -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Requisitos da senha:</h3>
                    <ul class="space-y-1 text-sm">
                        <li id="req-length" class="flex items-center text-gray-500">
                            <span class="check-icon mr-2">○</span>
                            Pelo menos 8 caracteres
                        </li>
                        <li id="req-uppercase" class="flex items-center text-gray-500">
                            <span class="check-icon mr-2">○</span>
                            Uma letra maiúscula
                        </li>
                        <li id="req-lowercase" class="flex items-center text-gray-500">
                            <span class="check-icon mr-2">○</span>
                            Uma letra minúscula
                        </li>
                        <li id="req-number" class="flex items-center text-gray-500">
                            <span class="check-icon mr-2">○</span>
                            Um número
                        </li>
                        <li id="req-special" class="flex items-center text-gray-500">
                            <span class="check-icon mr-2">○</span>
                            Um caractere especial (!@#$%^&*)
                        </li>
                    </ul>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <button type="submit"
                            id="submit-btn"
                            disabled
                            class="flex-1 bg-gray-300 text-gray-500 px-6 py-3 rounded-lg font-medium cursor-not-allowed">
                        Alterar Senha
                    </button>

                    <a href="{% url 'core:profile' %}"
                       class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium text-center">
                        Cancelar
                    </a>
                </div>
            </form>
        </div>

        <!-- Security Tips -->
        <div class="mt-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
            <h3 class="text-sm font-medium text-blue-800 dark:text-blue-400 mb-2">
                <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                Dicas de segurança
            </h3>
            <ul class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                <li>• Use uma senha única que você não usa em outros lugares</li>
                <li>• Evite informações pessoais como nome, data de nascimento</li>
                <li>• Considere usar um gerenciador de senhas</li>
                <li>• Nunca compartilhe sua senha com outras pessoas</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Password visibility toggle
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const type = field.getAttribute('type') === 'password' ? 'text' : 'password';
    field.setAttribute('type', type);
}

// Password strength checker
function checkPasswordStrength(password) {
    let score = 0;
    const requirements = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /\d/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
    };

    // Update requirement indicators
    Object.keys(requirements).forEach(req => {
        const element = document.getElementById(`req-${req}`);
        const icon = element.querySelector('.check-icon');

        if (requirements[req]) {
            element.className = 'flex items-center text-green-600';
            icon.textContent = '✓';
            score++;
        } else {
            element.className = 'flex items-center text-gray-500';
            icon.textContent = '○';
        }
    });

    return { score, requirements };
}

// Update strength bar
function updateStrengthIndicator(score) {
    const strengthBar = document.getElementById('strength-bar');
    const strengthText = document.getElementById('strength-text');

    const levels = [
        { text: 'Muito fraca', color: 'bg-red-500', width: '20%' },
        { text: 'Fraca', color: 'bg-red-400', width: '40%' },
        { text: 'Regular', color: 'bg-yellow-500', width: '60%' },
        { text: 'Boa', color: 'bg-blue-500', width: '80%' },
        { text: 'Muito boa', color: 'bg-green-500', width: '100%' }
    ];

    const level = levels[score] || levels[0];

    strengthBar.className = `h-2 rounded-full transition-all duration-300 ${level.color}`;
    strengthBar.style.width = level.width;
    strengthText.textContent = level.text;
    strengthText.className = `text-sm ${level.color.replace('bg-', 'text-')}`;
}

// Form validation
function validateForm() {
    const currentPassword = document.getElementById('current_password').value;
    const newPassword1 = document.getElementById('new_password1').value;
    const newPassword2 = document.getElementById('new_password2').value;
    const submitBtn = document.getElementById('submit-btn');

    const { score, requirements } = checkPasswordStrength(newPassword1);
    const passwordsMatch = newPassword1 === newPassword2;
    const allRequirementsMet = Object.values(requirements).every(req => req);

    // Update password match indicator
    const matchMessage = document.getElementById('password-match-message');
    if (newPassword2) {
        matchMessage.classList.remove('hidden');
        if (passwordsMatch) {
            matchMessage.textContent = 'Senhas coincidem ✓';
            matchMessage.className = 'mt-1 text-sm text-green-600';
        } else {
            matchMessage.textContent = 'Senhas não coincidem';
            matchMessage.className = 'mt-1 text-sm text-red-600';
        }
    } else {
        matchMessage.classList.add('hidden');
    }

    // Update strength indicator
    if (newPassword1) {
        updateStrengthIndicator(score);
    }

    // Enable/disable submit button
    const canSubmit = currentPassword && newPassword1 && newPassword2 &&
                     passwordsMatch && allRequirementsMet;

    if (canSubmit) {
        submitBtn.disabled = false;
        submitBtn.className = 'flex-1 bg-symplifika-primary text-white px-6 py-3 rounded-lg hover:bg-symplifika-accent transition-colors font-medium cursor-pointer';
        submitBtn.textContent = 'Alterar Senha';
    } else {
        submitBtn.disabled = true;
        submitBtn.className = 'flex-1 bg-gray-300 text-gray-500 px-6 py-3 rounded-lg font-medium cursor-not-allowed';
        submitBtn.textContent = 'Alterar Senha';
    }
}

// Event listeners
document.getElementById('new_password1').addEventListener('input', validateForm);
document.getElementById('new_password2').addEventListener('input', validateForm);
document.getElementById('current_password').addEventListener('input', validateForm);

// Form submission
document.getElementById('passwordForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // Show loading state
    const submitBtn = document.getElementById('submit-btn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Alterando...';
    submitBtn.disabled = true;

    // Simulate form submission (replace with actual form submission)
    setTimeout(() => {
        // Reset button state
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;

        // Show success message (you can customize this)
        alert('Senha alterada com sucesso!');

        // Redirect to profile or reload page
        window.location.href = "{% url 'core:profile' %}";
    }, 2000);
});

// Initialize form validation
validateForm();
</script>
{% endblock %}
