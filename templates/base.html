{% load static %}
<!doctype html>
<html lang="pt-br" class="{% block html_class %}{% endblock %}">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"
        />
        <meta
            name="description"
            content="{% block meta_description %}Symplifika - Automações fáceis e rápidas no seu dia-a-dia{% endblock %}"
        />
        <meta
            name="keywords"
            content="{% block meta_keywords %}automação, atalhos, produtividade, django{% endblock %}"
        />
        <meta name="author" content="Symplifika" />

        <!-- PWA Meta Tags -->
        <meta name="theme-color" content="#00C853" />
        <meta name="msapplication-TileColor" content="#00C853" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />
        <meta name="apple-mobile-web-app-title" content="Symplifika" />
        <meta name="mobile-web-app-capable" content="yes" />

        <!-- iOS Splash Screens -->
        <link
            rel="apple-touch-startup-image"
            href="{% static 'images/splash-640x1136.png' %}"
            media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)"
        />
        <link
            rel="apple-touch-startup-image"
            href="{% static 'images/splash-750x1334.png' %}"
            media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)"
        />
        <link
            rel="apple-touch-startup-image"
            href="{% static 'images/splash-1242x2208.png' %}"
            media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)"
        />

        <!-- Performance and Security -->
        <meta name="format-detection" content="telephone=no" />
        <meta name="x-dns-prefetch-control" content="on" />
        <link rel="dns-prefetch" href="//fonts.googleapis.com" />
        <link rel="dns-prefetch" href="//fonts.gstatic.com" />
        <link
            rel="preconnect"
            href="https://fonts.googleapis.com"
            crossorigin
        />

        <!-- CSRF Token -->
        <meta name="csrf-token" content="{{ csrf_token }}" />

        <title>{% block title %}Symplifika - Seus Atalhos{% endblock %}</title>

        <!-- Favicons and Touch Icons -->
        <link
            rel="icon"
            type="image/x-icon"
            href="{% static 'images/favicon.ico' %}"
        />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="{% static 'images/apple-touch-icon.png' %}"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="{% static 'images/favicon-32x32.png' %}"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="{% static 'images/favicon-16x16.png' %}"
        />
        <link rel="manifest" href="{% static 'manifest.json' %}" />
        <!-- SVG Favicon for modern browsers using Symplifika logo -->
        <link
            rel="icon"
            type="image/svg+xml"
            href="{% static 'images/symplifika_logo.svg' %}"
        />

        <!-- Tailwind CSS via CDN -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Google Fonts: Poppins (Optimized for Mobile) -->
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap"
            rel="stylesheet"
            media="print"
            onload="this.media='all'"
        />
        <noscript>
            <link
                href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap"
                rel="stylesheet"
            />
        </noscript>

        <!-- Custom CSS -->
        <link rel="stylesheet" href="{% static 'css/base.css' %}" />
        <link
            rel="stylesheet"
            href="{% static 'css/components/navbar.css' %}"
        />
        <link rel="stylesheet" href="{% static 'css/components/modal.css' %}" />
        <link
            rel="stylesheet"
            href="{% static 'css/responsive-mobile.css' %}"
        />
        <link
            rel="stylesheet"
            href="{% static 'css/components/forms-mobile.css' %}"
        />
        <link
            rel="stylesheet"
            href="{% static 'css/components/cookie-consent.css' %}"
        />

        {% block extra_css %}{% endblock %}

        <!-- Custom Tailwind Config -->
        <script>
            tailwind.config = {
                darkMode: "class",
                theme: {
                    extend: {
                        fontFamily: {
                            poppins: ["Poppins", "sans-serif"],
                        },
                        colors: {
                            symplifika: {
                                primary: "#00C853",
                                secondary: "#00FF57",
                                accent: "#4CAF50",
                            },
                        },
                    },
                },
            };
        </script>
    </head>
    <body
        class="{% block body_class %}bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-poppins{% endblock %} safe-area-inset"
        data-mobile-utils="enabled"
    >
        <!-- Messages Framework -->
        {% if messages %}
        <div class="fixed top-4 right-4 z-50">
            {% for message in messages %}
            <div
                class="alert alert-{{ message.tags }} mb-2 px-4 py-3 rounded-lg shadow-lg
                    {% if message.tags == 'error' %}bg-red-100 border border-red-400 text-red-700
                    {% elif message.tags == 'warning' %}bg-yellow-100 border border-yellow-400 text-yellow-700
                    {% elif message.tags == 'success' %}bg-green-100 border border-green-400 text-green-700
                    {% else %}bg-blue-100 border border-blue-400 text-blue-700{% endif %}
                "
                role="alert"
            >
                {{ message }}
                <button
                    type="button"
                    class="float-right font-bold text-xl leading-none"
                    onclick="this.parentElement.remove()"
                >
                    ×
                </button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Navigation -->
        {% block navigation %} {% include 'includes/navbar.html' %}
        <!--prettier-ignore--->
        {% endblock %}

        <!-- Main Content -->
        <main class="{% block main_class %}{% endblock %}">
            {% block content %} {% endblock %}
        </main>

        <!-- Footer -->
        {% block footer %} {% include 'includes/footer.html' %} {% endblock %}

        <!-- Cookie Consent Popup -->
        {% include 'components/cookie_consent.html' %}

        <!-- Loading Spinner -->
        <div
            id="loadingSpinner"
            class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        >
            <div
                class="spinner border-4 border-gray-300 border-t-symplifika-primary rounded-full w-12 h-12 animate-spin"
            ></div>
        </div>

        <!-- API Configuration -->
        <script>
            window.apiConfig = JSON.parse('{{ api_config|escapejs }}');
        </script>
        
        <!-- JavaScript -->
        <script src="{% static 'js/api-config.js' %}"></script>
        <script src="{% static 'js/symplifika-base.js' %}"></script>
        <script src="{% static 'js/base.js' %}"></script>
        <script src="{% static 'js/mobile/mobile-utils.js' %}"></script>
        <script src="{% static 'js/components/cookie-consent.js' %}"></script>
        {% block extra_js %}{% endblock %}

        <!-- CSRF Token for AJAX -->
        <script>
            // Get CSRF token for AJAX requests
            function getCSRFToken() {
                return (
                    document.querySelector("[name=csrfmiddlewaretoken]")
                        .value ||
                    document
                        .querySelector('meta[name="csrf-token"]')
                        .getAttribute("content")
                );
            }

            // Setup CSRF for all AJAX requests and mobile optimizations
            window.addEventListener("DOMContentLoaded", function () {
                const csrfToken = getCSRFToken();
                if (csrfToken) {
                    // Set default headers for fetch requests
                    const originalFetch = window.fetch;
                    window.fetch = function (url, options = {}) {
                        if (!options.headers) {
                            options.headers = {};
                        }
                        if (typeof options.headers === "object") {
                            options.headers["X-CSRFToken"] = csrfToken;
                        }
                        return originalFetch(url, options);
                    };
                }

                // Mobile-specific initializations
                if (window.MobileUtils) {
                    window.MobileUtils.setSafeAreaInsets();
                    window.MobileUtils.optimizeImages();
                    window.MobileUtils.improveForms();
                }

                // Register service worker for PWA functionality
                if (
                    "serviceWorker" in navigator &&
                    location.protocol === "https:"
                ) {
                    navigator.serviceWorker
                        .register("/sw.js")
                        .catch(function (error) {
                            console.log(
                                "ServiceWorker registration failed: ",
                                error,
                            );
                        });
                }

                // Handle installation prompt
                let deferredPrompt;
                window.addEventListener("beforeinstallprompt", (e) => {
                    e.preventDefault();
                    deferredPrompt = e;

                    // Show install button if needed
                    const installButton =
                        document.getElementById("install-app-button");
                    if (installButton) {
                        installButton.style.display = "block";
                        installButton.addEventListener("click", () => {
                            deferredPrompt.prompt();
                            deferredPrompt.userChoice.then((choiceResult) => {
                                if (choiceResult.outcome === "accepted") {
                                    console.log(
                                        "User accepted the install prompt",
                                    );
                                }
                                deferredPrompt = null;
                                installButton.style.display = "none";
                            });
                        });
                    }
                });
            });
        </script>
    </body>
</html>
