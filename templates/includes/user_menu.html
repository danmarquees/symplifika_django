{% load static %}

<!-- User Menu Dropdown Component -->
<div class="user-menu-container relative" id="userMenuContainer">
    <!-- User Menu Trigger Button -->
    <button
        type="button"
        class="user-menu-trigger flex items-center p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-symplifika-primary focus:ring-opacity-50"
        id="userMenuTrigger"
        aria-expanded="false"
        aria-haspopup="true"
        aria-label="Menu do usuário"
    >
        <!-- User Avatar -->
        <div class="user-avatar relative">
            {% if user.profile.avatar %}
            <img
                src="{{ user.profile.avatar.url }}"
                alt="Avatar de {{ user.get_full_name|default:user.username }}"
                class="w-10 h-10 rounded-full object-cover border-2 border-white dark:border-gray-600 shadow-sm"
            />
            {% else %}
            <div
                class="w-10 h-10 rounded-full bg-gradient-to-br from-symplifika-primary to-symplifika-secondary flex items-center justify-center text-white font-semibold text-sm shadow-sm"
            >
                {{ user.get_full_name|default:user.username|first|upper }}
            </div>
            {% endif %}

            <!-- Online Status Indicator -->
            <div
                class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-white dark:border-gray-800"
                title="Online"
            ></div>
        </div>

        <!-- User Info (Desktop) -->
        <div class="hidden md:flex flex-col items-start ml-3 mr-2">
            <span
                class="text-sm font-medium text-gray-700 dark:text-gray-200 truncate max-w-32"
            >
                {{ user.get_full_name|default:user.username }}
            </span>
            <span class="text-xs text-gray-500 dark:text-gray-400">
                {% if user.profile.plan %} {{ user.profile.plan.name }}
                <!-- prettier-ignore -->
                {% else %} Plano Gratuito {% endif %}
            </span>
        </div>

        <!-- Chevron Icon -->
        <svg
            class="user-menu-chevron w-4 h-4 text-gray-500 dark:text-gray-400 transition-transform duration-200 ml-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
            />
        </svg>
    </button>

    <!-- Dropdown Menu -->
    <div
        id="userMenuDropdown"
        class="user-menu-dropdown absolute right-0 top-full mt-2 w-72 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-600 z-50 opacity-0 invisible transform -translate-y-2 transition-all duration-200 ease-out"
        role="menu"
        aria-orientation="vertical"
        aria-labelledby="userMenuTrigger"
    >
        <!-- User Info Header -->
        <div
            class="user-info-header p-4 border-b border-gray-200 dark:border-gray-600"
        >
            <div class="flex items-center space-x-3">
                <!-- Avatar (Larger in dropdown) -->
                {% if user.profile.avatar %}
                <img
                    src="{{ user.profile.avatar.url }}"
                    alt="Avatar de {{ user.get_full_name|default:user.username }}"
                    class="w-12 h-12 rounded-full object-cover"
                />
                {% else %}
                <div
                    class="w-12 h-12 rounded-full bg-gradient-to-br from-symplifika-primary to-symplifika-secondary flex items-center justify-center text-white font-semibold"
                >
                    {{ user.get_full_name|default:user.username|first|upper }}
                </div>
                {% endif %}

                <!-- User Details -->
                <div class="flex-1 min-w-0">
                    <h3
                        class="text-sm font-semibold text-gray-900 dark:text-white truncate"
                    >
                        {{ user.get_full_name|default:user.username }}
                    </h3>
                    <p
                        class="text-sm text-gray-500 dark:text-gray-400 truncate"
                    >
                        {{ user.email }}
                    </p>
                    <div class="flex items-center mt-1">
                        {% if user.profile.plan %}
                        <span
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-symplifika-primary bg-opacity-20 text-symplifika-primary"
                        >
                            <svg
                                class="w-3 h-3 mr-1"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 17.5 9.134a1 1 0 010 1.732L14.146 12.8l-1.179 4.456a1 1 0 01-1.934 0L9.854 12.8 6.5 10.866a1 1 0 010-1.732L9.854 7.2l1.179-4.456A1 1 0 0112 2z"
                                    clip-rule="evenodd"
                                />
                            </svg>
                            {{ user.profile.plan.name }}
                        </span>
                        {% else %}
                        <span
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300"
                        >
                            Gratuito
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Menu Items -->
        <div class="py-2">
            <!-- Profile Section -->
            <div class="menu-section">
                <a
                    href="{% url 'users:profile' %}"
                    class="menu-item flex items-center px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150"
                    role="menuitem"
                >
                    <svg
                        class="menu-icon w-5 h-5 text-gray-400 mr-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                        />
                    </svg>
                    <div>
                        <div
                            class="text-sm font-medium text-gray-900 dark:text-white"
                        >
                            Meu Perfil
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            Editar informações pessoais
                        </div>
                    </div>
                </a>

                <a
                    href="{% url 'users:settings' %}"
                    class="menu-item flex items-center px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150"
                    role="menuitem"
                >
                    <svg
                        class="menu-icon w-5 h-5 text-gray-400 mr-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                        />
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                        />
                    </svg>
                    <div>
                        <div
                            class="text-sm font-medium text-gray-900 dark:text-white"
                        >
                            Configurações
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            Preferências da conta
                        </div>
                    </div>
                </a>
            </div>

            <div
                class="border-t border-gray-200 dark:border-gray-600 my-2"
            ></div>

            <!-- Shortcuts Section -->
            <div class="menu-section">
                <a
                    href="{% url 'shortcuts:list' %}"
                    class="menu-item flex items-center px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150"
                    role="menuitem"
                >
                    <svg
                        class="menu-icon w-5 h-5 text-gray-400 mr-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z"
                        />
                    </svg>
                    <div>
                        <div
                            class="text-sm font-medium text-gray-900 dark:text-white"
                        >
                            Meus Atalhos
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            Gerenciar atalhos salvos
                        </div>
                    </div>
                </a>

                <a
                    href="{% url 'shortcuts:favorites' %}"
                    class="menu-item flex items-center px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150"
                    role="menuitem"
                >
                    <svg
                        class="menu-icon w-5 h-5 text-gray-400 mr-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                        />
                    </svg>
                    <div>
                        <div
                            class="text-sm font-medium text-gray-900 dark:text-white"
                        >
                            Favoritos
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            Atalhos marcados como favoritos
                        </div>
                    </div>
                </a>
            </div>

            <div
                class="border-t border-gray-200 dark:border-gray-600 my-2"
            ></div>

            <!-- Plan & Billing Section -->
            {% if not user.profile.plan or user.profile.plan.name == 'Free' %}
            <div class="menu-section">
                <a
                    href="{% url 'core:pricing' %}"
                    class="menu-item flex items-center px-4 py-3 hover:bg-symplifika-primary hover:bg-opacity-10 transition-colors duration-150 group"
                    role="menuitem"
                >
                    <svg
                        class="menu-icon w-5 h-5 text-symplifika-primary mr-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"
                        />
                    </svg>
                    <div>
                        <div
                            class="text-sm font-medium text-symplifika-primary group-hover:text-symplifika-accent"
                        >
                            Fazer Upgrade
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            Desbloqueie recursos premium
                        </div>
                    </div>
                    <div class="ml-auto">
                        <span
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-symplifika-primary text-white"
                        >
                            PRO
                        </span>
                    </div>
                </a>
            </div>
            {% else %}
            <div class="menu-section">
                <a
                    href="#"
                    class="menu-item flex items-center px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150"
                    role="menuitem"
                >
                    <svg
                        class="menu-icon w-5 h-5 text-gray-400 mr-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
                        />
                    </svg>
                    <div>
                        <div
                            class="text-sm font-medium text-gray-900 dark:text-white"
                        >
                            Faturamento
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            Gerenciar plano e pagamentos
                        </div>
                    </div>
                </a>
            </div>
            {% endif %}

            <div
                class="border-t border-gray-200 dark:border-gray-600 my-2"
            ></div>

            <!-- Support & Help Section -->
            <div class="menu-section">
                <a
                    href="{% url 'core:help' %}"
                    class="menu-item flex items-center px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150"
                    role="menuitem"
                >
                    <svg
                        class="menu-icon w-5 h-5 text-gray-400 mr-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                    </svg>
                    <div>
                        <div
                            class="text-sm font-medium text-gray-900 dark:text-white"
                        >
                            Ajuda & Suporte
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            FAQ e documentação
                        </div>
                    </div>
                </a>

                <a
                    href="{% url 'core:feedback' %}"
                    class="menu-item flex items-center px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150"
                    role="menuitem"
                >
                    <svg
                        class="menu-icon w-5 h-5 text-gray-400 mr-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"
                        />
                    </svg>
                    <div>
                        <div
                            class="text-sm font-medium text-gray-900 dark:text-white"
                        >
                            Feedback
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            Compartilhe sua opinião
                        </div>
                    </div>
                </a>
            </div>

            <div
                class="border-t border-gray-200 dark:border-gray-600 my-2"
            ></div>

            <!-- Theme Toggle -->
            <div class="menu-section">
                <button
                    type="button"
                    id="themeToggle"
                    class="menu-item flex items-center px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150 w-full text-left"
                    role="menuitem"
                >
                    <svg
                        class="menu-icon w-5 h-5 text-gray-400 mr-3 dark:hidden"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                        />
                    </svg>
                    <svg
                        class="menu-icon w-5 h-5 text-gray-400 mr-3 hidden dark:block"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                        />
                    </svg>
                    <div>
                        <div
                            class="text-sm font-medium text-gray-900 dark:text-white"
                        >
                            <span class="dark:hidden">Modo Escuro</span>
                            <span class="hidden dark:inline">Modo Claro</span>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            Alterar aparência
                        </div>
                    </div>
                </button>
            </div>

            <div
                class="border-t border-gray-200 dark:border-gray-600 my-2"
            ></div>

            <!-- Logout -->
            <div class="menu-section">
                <form method="post" action="#" class="w-full">
                    {% csrf_token %}
                    <button
                        type="submit"
                        class="menu-item flex items-center px-4 py-3 hover:bg-red-50 hover:text-red-600 dark:hover:bg-red-900 dark:hover:bg-opacity-20 transition-colors duration-150 w-full text-left group"
                        role="menuitem"
                    >
                        <svg
                            class="menu-icon w-5 h-5 text-gray-400 group-hover:text-red-500 mr-3"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                            />
                        </svg>
                        <div>
                            <div
                                class="text-sm font-medium text-gray-900 dark:text-white group-hover:text-red-600"
                            >
                                Sair
                            </div>
                            <div
                                class="text-xs text-gray-500 dark:text-gray-400"
                            >
                                Encerrar sessão
                            </div>
                        </div>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .user-menu-container {
        position: relative;
    }

    .user-menu-trigger:hover .user-avatar img,
    .user-menu-trigger:hover .user-avatar > div {
        transform: scale(1.05);
    }

    .user-menu-trigger[aria-expanded="true"] .user-menu-chevron {
        transform: rotate(180deg);
    }

    .user-menu-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .user-menu-dropdown {
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow:
            0 20px 25px -5px rgba(0, 0, 0, 0.1),
            0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .dark .user-menu-dropdown {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        box-shadow:
            0 20px 25px -5px rgba(0, 0, 0, 0.3),
            0 10px 10px -5px rgba(0, 0, 0, 0.2);
    }

    .menu-item {
        cursor: pointer;
    }

    .menu-item:hover .menu-icon {
        color: #00c853;
        transform: translateX(2px);
    }

    .menu-item:focus {
        outline: 2px solid #00c853;
        outline-offset: -2px;
    }

    /* Mobile Responsive */
    @media (max-width: 640px) {
        .user-menu-dropdown {
            right: -1rem;
            width: calc(100vw - 2rem);
            max-width: 20rem;
        }
    }

    /* High contrast mode */
    @media (prefers-contrast: high) {
        .user-menu-dropdown {
            border-width: 2px;
        }

        .menu-item:hover {
            background-color: #000 !important;
            color: #fff !important;
        }

        .dark .menu-item:hover {
            background-color: #fff !important;
            color: #000 !important;
        }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
        .user-menu-dropdown,
        .user-menu-chevron,
        .menu-item,
        .menu-icon {
            transition: none;
        }
    }
</style>

<script>
    // User Menu Dropdown JavaScript
    class UserMenu {
        constructor() {
            this.trigger = document.getElementById("userMenuTrigger");
            this.dropdown = document.getElementById("userMenuDropdown");
            this.themeToggle = document.getElementById("themeToggle");
            this.isOpen = false;

            this.init();
        }

        init() {
            this.bindEvents();
            this.setupThemeToggle();
            this.setupKeyboardNavigation();
        }

        bindEvents() {
            // Trigger click
            this.trigger.addEventListener("click", (e) => {
                e.preventDefault();
                this.toggle();
            });

            // Close on outside click
            document.addEventListener("click", (e) => {
                if (
                    !this.trigger.contains(e.target) &&
                    !this.dropdown.contains(e.target)
                ) {
                    this.close();
                }
            });

            // Close on escape key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && this.isOpen) {
                    this.close();
                    this.trigger.focus();
                }
            });

            // Menu item navigation
            const menuItems =
                this.dropdown.querySelectorAll('[role="menuitem"]');
            menuItems.forEach((item) => {
                item.addEventListener("keydown", (e) => {
                    this.handleMenuItemKeydown(e, item, menuItems);
                });
            });
        }

        toggle() {
            if (this.isOpen) {
                this.close();
            } else {
                this.open();
            }
        }

        open() {
            this.dropdown.classList.add("show");
            this.trigger.setAttribute("aria-expanded", "true");
            this.isOpen = true;

            // Focus first menu item
            setTimeout(() => {
                const firstItem =
                    this.dropdown.querySelector('[role="menuitem"]');
                if (firstItem) {
                    firstItem.focus();
                }
            }, 100);

            // Track analytics
            this.trackEvent("user_menu_opened");
        }

        close() {
            this.dropdown.classList.remove("show");
            this.trigger.setAttribute("aria-expanded", "false");
            this.isOpen = false;
        }

        setupThemeToggle() {
            if (this.themeToggle) {
                this.themeToggle.addEventListener("click", () => {
                    this.toggleTheme();
                });
            }
        }

        toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains("dark");

            if (isDark) {
                html.classList.remove("dark");
                localStorage.setItem("theme", "light");
                this.trackEvent("theme_changed", { theme: "light" });
            } else {
                html.classList.add("dark");
                localStorage.setItem("theme", "dark");
                this.trackEvent("theme_changed", { theme: "dark" });
            }

            // Close menu after theme change
            this.close();
        }

        setupKeyboardNavigation() {
            this.trigger.addEventListener("keydown", (e) => {
                if (e.key === "Enter" || e.key === " ") {
                    e.preventDefault();
                    this.toggle();
                } else if (e.key === "ArrowDown" && !this.isOpen) {
                    e.preventDefault();
                    this.open();
                }
            });
        }

        handleMenuItemKeydown(e, currentItem, allItems) {
            const currentIndex = Array.from(allItems).indexOf(currentItem);

            switch (e.key) {
                case "ArrowDown":
                    e.preventDefault();
                    const nextIndex = (currentIndex + 1) % allItems.length;
                    allItems[nextIndex].focus();
                    break;

                case "ArrowUp":
                    e.preventDefault();
                    const prevIndex =
                        currentIndex === 0
                            ? allItems.length - 1
                            : currentIndex - 1;
                    allItems[prevIndex].focus();
                    break;

                case "Home":
                    e.preventDefault();
                    allItems[0].focus();
                    break;

                case "End":
                    e.preventDefault();
                    allItems[allItems.length - 1].focus();
                    break;

                case "Tab":
                    // Allow natural tab behavior to close menu
                    this.close();
                    break;
            }
        }

        trackEvent(eventName, properties = {}) {
            // Analytics tracking
            if (typeof gtag !== "undefined") {
                gtag("event", eventName, properties);
            }

            // Custom analytics
            if (
                window.analytics &&
                typeof window.analytics.track === "function"
            ) {
                window.analytics.track(eventName, properties);
            }
        }
    }

    // Initialize user menu when DOM is ready
    document.addEventListener("DOMContentLoaded", function () {
        new UserMenu();
    });

    // Global function for external use
    window.openUserMenu = function () {
        const userMenu = document.querySelector(".user-menu-container");
        if (userMenu && userMenu.userMenuInstance) {
            userMenu.userMenuInstance.open();
        }
    };

    window.closeUserMenu = function () {
        const userMenu = document.querySelector(".user-menu-container");
        if (userMenu && userMenu.userMenuInstance) {
            userMenu.userMenuInstance.close();
        }
    };
</script>

<!--
Usage Notes:

1. User Authentication:
   This component assumes user is authenticated and has access to:
   - user.get_full_name or user.username
   - user.email
   - user.profile.avatar (optional)
   - user.profile.plan (optional)

2. URL Names:
   Update these URL names to match your project:
   - users:profile
   - users:settings
   - shortcuts:list
   - shortcuts:favorites
   - core:pricing
   - payments:billing
   - core:help
   - core:feedback
   - auth:logout

3. Theme Toggle:
   The theme toggle works with Tailwind's dark mode class strategy.
   It stores preference in localStorage and toggles the 'dark' class on html element.

4. Plan Logic:
   The component shows upgrade prompt for free users and billing link for paid users.
   Adjust the logic based on your plan structure.

5. Avatar Handling:
   Shows user's uploaded avatar or generates initials-based avatar with gradient background.

6. Keyboard Navigation:
   - Enter/Space: Open/close menu
   - Arrow keys: Navigate menu items
   - Escape: Close menu
   - Tab: Natural tab behavior (closes menu)

7. Analytics:
   Tracks user interactions for analytics (Google Analytics and custom analytics).

8. Accessibility:
   - ARIA attributes for screen readers
   - Keyboard navigation support
   - Focus management
   - High contrast mode support

9. Mobile Responsive:
   Adjusts dropdown position and width for mobile devices.

10. Customization:
    Easily customize menu items, styling, and behavior by modifying the HTML structure and CSS classes.
-->
